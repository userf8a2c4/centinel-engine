# deploy-dashboard.yml
# Validates and deploys the Sentinel Streamlit dashboard
# Valida y despliega el dashboard Streamlit de Sentinel

name: Deploy Streamlit Dashboard

permissions:
  contents: read

on:
  push:
    branches: [main, dev, dev-v2, dev-v3]
    paths:
      - 'src/sentinel/dashboard/**'
      - 'dashboard.py'
      - '.streamlit/**'
      - 'requirements.txt'
      - '.github/workflows/deploy-dashboard.yml'
  pull_request:
    branches: [main, dev, dev-v2, dev-v3]
    paths:
      - 'src/sentinel/dashboard/**'
      - 'dashboard.py'
      - '.streamlit/**'
      - 'requirements.txt'
      - '.github/workflows/deploy-dashboard.yml'
  workflow_dispatch:

jobs:
  validate-dashboard:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Validate Streamlit config
        run: |
          echo "Checking .streamlit/config.toml exists..."
          test -f .streamlit/config.toml
          echo "Streamlit config OK"

      - name: Validate dashboard entry point
        run: |
          test -f dashboard.py
          echo "Entry point dashboard.py OK"

      - name: Validate dashboard module imports
        env:
          PYTHONPATH: ${{ github.workspace }}/src
        run: |
          python -c "
          from sentinel.dashboard.main import run_dashboard
          from sentinel.dashboard.data_loader import load_data
          from sentinel.dashboard.filters import filtrar_df
          from sentinel.dashboard.components.overview import render_overview
          from sentinel.dashboard.components.department_tab import render_department_tab
          from sentinel.dashboard.components.temporal_tab import render_temporal_tab
          from sentinel.dashboard.components.integrity_tab import render_integrity_tab
          from sentinel.dashboard.components.pdf_generator import create_pdf
          from sentinel.dashboard.utils.constants import PARTIES, DEPARTMENTS
          from sentinel.dashboard.utils.benford import *
          print('All dashboard module imports OK')
          "

      - name: Validate dashboard structure
        run: |
          echo "Checking dashboard package structure..."
          test -f src/sentinel/dashboard/__init__.py
          test -f src/sentinel/dashboard/main.py
          test -f src/sentinel/dashboard/data_loader.py
          test -f src/sentinel/dashboard/filters.py
          test -d src/sentinel/dashboard/components
          test -d src/sentinel/dashboard/utils
          test -d src/sentinel/dashboard/pages
          echo "Dashboard structure OK"

      - name: Check Streamlit version compatibility
        run: |
          python -c "
          import streamlit
          version = tuple(int(x) for x in streamlit.__version__.split('.')[:2])
          assert version >= (1, 31), f'Streamlit {streamlit.__version__} < 1.31.0'
          print(f'Streamlit {streamlit.__version__} OK')
          "

      - name: Dashboard validation passed
        run: echo "Dashboard is valid and ready for deployment to https://centinel.streamlit.app/"
